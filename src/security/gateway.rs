// use crate::audit::logger::{LogLevel, Logger};
use axum::{
    // body::Bytes,
    extract::Request,
    http::{Method, StatusCode},
    middleware::Next,
    response::Response,
};
// use std::sync::Arc;
// use tokio::sync::Mutex;

/// ============================================================================
/// üõ°Ô∏è Secure Gateway (‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∂ö ‡∂Ø‡∑ú‡∂ª‡∂ß‡∑î‡∑Ä)
/// ============================================================================
/// ‡∂∏‡∑ô‡∂∫ Microservice ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂Ø‡∑ú‡∂ª‡∂ß‡∑î‡∑Ä‡∂∫‡∑í (WAF).
/// ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∑É‡∑ë‡∂∏ Request ‡∂ë‡∂ö‡∂ö‡∑ä‡∂∏ ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑ô‡∂ª‡∑ö.

#[derive(Clone)]
pub struct SecurityConfig {
    /// ‡∑Ä‡∑í‡∂±‡∑è‡∂©‡∑í‡∂∫‡∂ö‡∂ß ‡∂Ω‡∑ê‡∂∂‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂ã‡∂¥‡∂ª‡∑í‡∂∏ ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä (Requests) ‡∂ú‡∂´‡∂±.
    pub max_requests_per_minute: u32,
    /// ‡∂Ö‡∂±‡∑í‡∑É‡∑í IP ‡∂Ω‡∑í‡∂¥‡∑í‡∂± ‡∂Ö‡∑Ä‡∑Ñ‡∑í‡∂ª ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä.
    pub block_malicious_ips: bool,
}

impl Default for SecurityConfig {
    fn default() -> Self {
        Self {
            max_requests_per_minute: 60, // ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫‡∂∫‡∑ô‡∂±‡∑ä ‡∂≠‡∂≠‡∑ä‡∂¥‡∂ª‡∂∫‡∂ö‡∂ß 1 ‡∂∂‡∑ê‡∂ú‡∑í‡∂±‡∑ä.
            block_malicious_ips: true,
        }
    }
}

/// üõ°Ô∏è Main Middleware Logic: ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è‡∑Ä
/// ‡∂∏‡∑ô‡∂∏ function ‡∂ë‡∂ö ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂ë‡∂± ‡∑É‡∑ë‡∂∏ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä‡∂∏ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª ‡∂ë‡∂∫ ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠‡∂Ø‡∑ê‡∂∫‡∑í ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í.
pub async fn secure_guard(req: Request, next: Next) -> Result<Response, StatusCode> {
    // 1. Check Method: ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑ä‡∂±‡∑ö POST ‡∑É‡∑Ñ GET ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∑í.
    if req.method() != Method::POST && req.method() != Method::GET {
        return Err(StatusCode::METHOD_NOT_ALLOWED);
    }

    // 2. Simple WAF Logic: URI ‡∂ë‡∂ö ‡∂≠‡∑î‡∑Ö ‡∂Ö‡∂±‡∑í‡∑É‡∑í ‡∂ö‡∑ö‡∂≠ (Attacks) ‡∂≠‡∑í‡∂∂‡∑ö‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
    let uri = req.uri().to_string();
    if is_malicious(&uri) {
        println!("üö® ALERT: Malicious Payload Detected in URI: {}", uri);
        // ‡∂Ö‡∂±‡∑í‡∑É‡∑í ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä ‡∂ë‡∂∫ ‡∑Ä‡∑Ñ‡∑è‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂ö‡∑ä‡∑Ç‡∑ö‡∂¥ ‡∂ö‡∂ª‡∂∫‡∑í.
        return Err(StatusCode::FORBIDDEN);
    }

    // 3. Logger Injection: ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
    println!(
        "üõ°Ô∏è GATEWAY: Request allowed -> {} {}",
        req.method(),
        req.uri()
    );

    // 4. Rate Limiting: ‡∂∏‡∑ô‡∑Ñ‡∑í‡∂Ø‡∑ì ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä ‡∂ú‡∂´‡∂± ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö.

    // ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è‡∑Ä‡∂±‡∑ä‡∂ú‡∑ô‡∂±‡∑ä ‡∂¥‡∑É‡∑î ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∏‡∑ì‡∑Ö‡∂ü ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª (Router) ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ú‡∂∏‡∑î ‡∂ö‡∂ª‡∂∫‡∑í.
    let response = next.run(req).await;
    Ok(response)
}

/// üïµÔ∏è Check for Hack Patterns: ‡∑Ñ‡∑ê‡∂ö‡∂ª‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ñ‡∑è‡∂ª ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
/// SQL Injection, XSS ‡∑Ä‡∑ê‡∂±‡∑í ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ñ‡∑è‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∂‡∑Ñ‡∑î‡∂Ω‡∑Ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∂± ‡∂ª‡∂ß‡∑è ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∫‡∑í.
fn is_malicious(input: &str) -> bool {
    // ‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î‡∂Ø‡∑è‡∂∫‡∂ö ‡∑Ä‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂ª‡∂ß‡∑è ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä.
    let patterns = vec![
        "union select", // SQL Injection
        "drop table",   // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ä‡∑í‡∂±‡∑è‡∑Å ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ‡∂∫‡∂±‡∑ä
        "<script>",     // XSS (Cross-Site Scripting)
        "alert(",       // ‡∂Ö‡∂±‡∑í‡∑É‡∑í JavaScript ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        "../",          // Path Traversal (‡∂ú‡∑ú‡∂±‡∑î ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∑î‡∑Ä‡∑ì‡∂∏)
        "exec(",        // ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∑Ä‡∑í‡∂∞‡∑è‡∂± ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        "base64_decode",
    ];

    let normalized = input.to_lowercase();
    for pattern in patterns {
        if normalized.contains(pattern) {
            return true; // ‡∂ª‡∂ß‡∑è‡∑Ä‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∑Ä‡∑î‡∑Ä‡∑Ñ‡∑ú‡∂≠‡∑ä ‡∂ë‡∂∫ ‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î‡∂Ø‡∑è‡∂∫‡∂ö ‡∂∂‡∑Ä ‡∂¥‡∑Ä‡∑É‡∂∫‡∑í.
        }
    }
    false // ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ª‡∂ß‡∑è‡∑Ä‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ñ‡∂∫‡∑ö ‡∂±‡∂∏‡∑ä ‡∂ë‡∂∫ ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠‡∂∫‡∑í.
}
